<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Barcode Scanner</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

  <style>
    * { box-sizing: border-box; font-family: Inter, sans-serif; }

    body {
      margin: 0;
      background: #f6f7fb;
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 420px;
      background: white;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    h1 {
      text-align: center;
      margin-bottom: 8px;
    }

    a {
      display: block;
      text-align: center;
      margin-bottom: 10px;
      color: #2563eb;
      font-weight: 600;
      text-decoration: none;
    }

    .scanner-box {
      position: relative;
      width: 100%;
      aspect-ratio: 3 / 4;
      border-radius: 12px;
      overflow: hidden;
      background: black;
    }

    #scanner, video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .frame {
      position: absolute;
      left: 8%;
      right: 8%;
      top: 42%;
      height: 18%;
      border: 3px solid #22c55e;
      border-radius: 10px;
    }

    .frame::after {
      content: "";
      position: absolute;
      inset: -3px;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.4);
    }

    .result {
      margin-top: 12px;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      font-weight: 600;
      min-height: 44px;
    }

    ul {
      list-style: none;
      padding: 0;
      margin-top: 12px;
    }

    li {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 6px;
      color: white;
      font-size: 14px;
    }

    .green { background: #22c55e; }
    .red { background: #ef4444; }
  </style>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner</title>

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f3f4f6;
  display: flex;
  justify-content: center;
  padding: 16px;
}

.app {
  width: 100%;
  max-width: 420px;
  background: white;
  border-radius: 14px;
  padding: 16px;
}

h1 { text-align: center; }

a {
  display: block;
  text-align: center;
  margin-bottom: 10px;
}

.scanner-box {
  position: relative;
  aspect-ratio: 3 / 4;
  background: black;
  border-radius: 12px;
  overflow: hidden;
}

#scanner, video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.frame {
  position: absolute;
  left: 8%;
  right: 8%;
  top: 45%;
  height: 15%;
  border: 3px solid #22c55e;
  border-radius: 10px;
}

.result {
  margin-top: 12px;
  padding: 12px;
  border-radius: 10px;
  font-weight: bold;
  text-align: center;
}

ul { list-style: none; padding: 0; }
li {
  padding: 8px;
  border-radius: 6px;
  margin-top: 6px;
  color: white;
}

.green { background: #22c55e; }
.red { background: #ef4444; }
</style>
</head>

<body>
<div class="app">
  <h1>Barcode Scanner</h1>
  <a href="attendance.html">View Attendance →</a>
  <h1>Scanner</h1>
  <a href="attendance.html">View Attendance</a>

  <div class="scanner-box">
    <div id="scanner"></div>
    <div class="frame"></div>
  </div>

  <div id="result" class="result">Align barcode inside frame</div>
  <div id="result" class="result">Scan ticket</div>
  <ul id="history"></ul>
</div>

<script>
  const attendance = JSON.parse(localStorage.getItem("attendanceList")) || [];
  const present = JSON.parse(localStorage.getItem("presentList")) || [];

  const resultEl = document.getElementById("result");
  const historyEl = document.getElementById("history");

  let lastScan = "";
  let lastTime = 0;

  Quagga.init({
    inputStream: {
      type: "LiveStream",
      target: document.querySelector("#scanner"),
      constraints: { facingMode: "environment" }
    },
    decoder: { readers: ["code_128_reader", "code_39_reader"] },
    locate: true
  }, err => {
    if (!err) Quagga.start();
  });

  Quagga.onDetected(data => {
    const now = Date.now();
    if (now - lastTime < 2500) return;

    let raw = data.codeResult.code;
    raw = raw.normalize("NFKC").replace(/\s+/g, " ").replace(/[^A-Za-z ]/g, "");
    const name = raw.trim();

    if (name.length < 4 || !name.includes(" ") || name === lastScan) return;

    lastScan = name;
    lastTime = now;

    const li = document.createElement("li");

    if (attendance.includes(name)) {
      li.className = "green";
      resultEl.textContent = `${name} ✓`;
      resultEl.style.background = "#dcfce7";

      if (!present.includes(name)) {
        present.push(name);
        localStorage.setItem("presentList", JSON.stringify(present));
      }
    } else {
      li.className = "red";
      resultEl.textContent = `${name} ✕`;
      resultEl.style.background = "#fee2e2";
/* ---------- NORMALISE FUNCTION (CRITICAL) ---------- */
function normalizeName(str) {
  return str
    .normalize("NFKC")
    .replace(/[^A-Za-z ]/g, "")
    .replace(/\s+/g, " ")
    .trim()
    .toLowerCase()
    .replace(/\b\w/g, c => c.toUpperCase());
}

/* ---------- LOAD LIST ---------- */
const attendanceList = {
  "11 Browne": [
    "Idris Bee","My Anh Cao","Ashley Chan","Cheng Zhe Xin","Sean Chia","Mir Kim",
    "Dawon Kim","Angelina Lai","Lucan Lee","Lee Le Jing","Nahyun Lee","Lee Ming Yuen",
    "Lim Jun Tong","Win Ny Lim","Sarveshwaran M","Ana Naeem","Ng Kayven","Win Sheng Ong",
    "Navya Sahu","Saw Tian Ying","Caden Tan","Tan Yu Shaun","Megan Wah","Angeline Wai",
    "Daniel Yeoh"
  ],
  "11 Gardner": [
    "Noah Abdullah","Ameer","Chloe Bayly","Niklaus Chan","Cruz Chan","Sheun Chan",
    "Chang Jun Xuan","Chong Yukki","Emily Chow","Dissha Harjeet Singh","Aidan Kadir",
    "Gyutae Kim","Timothy Lau","Hyoseon Lee","Eloise Lim","Lim Zhi Xuan","Lin Yu Tong",
    "Hannan Hafidz","David Oh","Benjamin Wong","Jo Chen Yap","Yaw Xuan Xi","River Yeong",
    "Kylasufiah Ziad"
  ],
  "11 Hattie": [
    "Amelia Aaron","Zara Carissa","Asher Chan","Chan Sze Cen","Chin Vernice Zi Xin",
    "May Davies","Angela Fu","Sophia Gow","Ho Kai Er","Victoria Hu","Haresh J","Tabitha S",
    "Jiho Kang","Yumin Kim","Reyan K","Amanda Liao","Lim Yu Hang","Ilan Naif",
    "Ashavihn Nezan","Harvard Ng","Yaashvin P","Ethan Seto","Yasmin Tho","Beth Wong",
    "Jo Shin Yap"
  ],
  "11 Sullivan": [
    "Choe Xin Ying","Atticus Goh","Neil Goswami","Ethan Jeevaraj","Seojun Kim",
    "Kua Eu Xiang","Lai Weng Hui","Lee Zi Rou","Lee Ming Yu","Amy L","Lee Chen Huan",
    "Lee Xhuen Yi","Cae Lyn Leong","Kylie Loi","Soudai Manabe","Anderson Louis",
    "Sulaymaan Mungaye","Lucas Philip","Reet Sachdeva","Le Ann Sia","Teioh Wu Yang",
    "Summer Teoh","Maya Wee","Wong Zhe Xun","Alexis Wong"
  ],
  "11 Keller": [
    "Qaisara A","Abdul Rahman","Jessalyn Chai","Edison Chow","Charlotte Chua","Tushita Dixit",
    "Kayson Goh","Seoyul Kim","Lee Pi Qi","Lee Jing Hao","Sean Lee","Liu Jiayi","Mario Mak",
    "Ng Jiun Yuh","Ooi Zhi Loon","Eunseo Park","Yunseo Roh","Yuvraj Neil","Seng Wen Jie",
    "Ethaan Siraj","Daniyal Siraj","Tung YiFan","Yap Xin Yee"
  ],
  "11 Montessori": [
    "Arif N","Ayush Balaji","Tavish Bansal","Jared Du","Eng Ken Ji","Olyvia Foley","Rachelle Goh",
    "Jae Won Ha","Myesha Hossain","Jiyul Kim","Alysha Lee","Lim Zhan Yi","Douglas Lim","Lim Xi",
    "Lim Wen Xin","Loh Kye Rin","Gavin","Kaelynn See","Shrividya Shivram","Pragnya Srinivasan",
    "Varshnee T","Wong Shan Li","Gabriel Wong","Jihyun Yoon"
  ]
};
const validNames = new Set(Object.values(attendanceList).flat());
const validNames = new Set(
  Object.values(rawList).flat().map(normalizeName)
);

let present = JSON.parse(localStorage.getItem("presentList")) || [];

const resultEl = document.getElementById("result");
const historyEl = document.getElementById("history");

let lastScan = "";
let lastTime = 0;

Quagga.init({
  inputStream: {
    type: "LiveStream",
    target: document.querySelector("#scanner"),
    constraints: { facingMode: "environment" }
  },
  decoder: { readers: ["code_128_reader", "code_39_reader"] }
}, err => {
  if (!err) Quagga.start();
});

Quagga.onDetected(data => {
  const now = Date.now();
  if (now - lastTime < 2500) return;

  let scanned = normalizeName(data.codeResult.code);
  if (!scanned || scanned === lastScan) return;

  lastScan = scanned;
  lastTime = now;

  const li = document.createElement("li");

  if (validNames.has(scanned)) {
    li.className = "green";
    resultEl.textContent = `${scanned} ✓`;
    resultEl.style.background = "#dcfce7";

    if (!present.includes(scanned)) {
      present.push(scanned);
      localStorage.setItem("presentList", JSON.stringify(present));
    }

    li.textContent = name;
    historyEl.prepend(li);
  });
  } else {
    li.className = "red";
    resultEl.textContent = `${scanned} ✕`;
    resultEl.style.background = "#fee2e2";
  }

  li.textContent = scanned;
  historyEl.prepend(li);
});
</script>
</body>
</html>
